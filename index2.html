<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Fluid / Air Bearing Analysis – K, C, ε, p(θ,z)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            line-height: 1.4;
        }

        body {
            margin: 0;
            background: #f5f5f7;
            color: #111827;
        }

        header {
            padding: 1rem 2rem;
            background: #111827;
            color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        header h1 {
            margin: 0;
            font-size: 1.25rem;
        }

        header span {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        main {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
            gap: 1rem;
        }

        .card {
            background: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.07);
            padding: 1rem 1.25rem;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .card h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .section-caption {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem 1rem;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: #4b5563;
            margin-bottom: 0.2rem;
        }

        input[type="number"],
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 0.35rem 0.4rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            font-size: 0.85rem;
            background: #f9fafb;
        }

        .inline-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        button {
            border-radius: 0.6rem;
            border: none;
            padding: 0.45rem 0.9rem;
            font-size: 0.85rem;
            cursor: pointer;
            background: #2563eb;
            color: #f9fafb;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4);
        }

        button.secondary {
            background: #e5e7eb;
            color: #111827;
            box-shadow: none;
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
        }

        .output-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .pill {
            background: #eff6ff;
            color: #1d4ed8;
            padding: 0.3rem 0.6rem;
            border-radius: 999px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 0.35rem 0.5rem;
            text-align: center;
        }

        th {
            background: #f3f4f6;
        }

        .matrix-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.2rem;
        }

        canvas {
            width: 100%;
            max-width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background: #111827;
            /* darker background */
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .tag {
            padding: 0.15rem 0.4rem;
            background: #e5e7eb;
            border-radius: 999px;
            color: #374151;
        }

        footer {
            padding: 0.75rem 1.5rem 1.25rem;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
        }

        .two-cols {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>Fluid Bearing Designer </h1>
            <span>K, C matrices • Eccentricity • Pressure field</span>
        </div>
        <button class="secondary" id="exportBtn">Export PDF</button>
    </header>

    <main>
        <section class="grid">
            <section class="card">
                <h2>1. Bearing and operating conditions</h2>
                <div class="form-grid">
                    <div>
                        <label for="bearingType">Bearing type</label>
                        <select id="bearingType">
                            <option value="journal">Journal bearing</option>

                        </select>
                    </div>
                    <div>
                        <label for="fluidType">Fluid</label>
                        <select id="fluidType">
                            <option value="oil">Oil (incompressible)</option>
                        </select>
                    </div>
                    <div>
                        <label for="radius">Radius R [m]</label>
                        <input id="radius" type="number" step="0.0001" value="0.05">
                    </div>
                    <div>
                        <label for="length">Length L [m]</label>
                        <input id="length" type="number" step="0.0001" value="0.1">
                    </div>
                    <div>
                        <label for="clearance">Radial clearance c [m]</label>
                        <input id="clearance" type="number" step="1e-6" value="0.0001">
                    </div>
                    <div>
                        <label for="speedRpm">Speed n [rpm]</label>
                        <input id="speedRpm" type="number" step="1" value="1500">
                    </div>
                    <div>
                        <label for="load">Static load W [N]</label>
                        <input id="load" type="number" step="1" value="1000">
                    </div>
                    <div>
                        <label for="viscosity">Dynamic viscosity μ [Pa·s]</label>
                        <input id="viscosity" type="number" step="0.001" value="0.1">
                    </div>

                </div>

                <div class="inline-row">
                    <button id="runBtn">Run analysis</button>
                    <button id="friswellBtn" class="secondary">Friswell example</button>
                    <span class="section-caption" id="statusText">Status: idle</span>
                </div>

                <div class="output-row">
                    <div class="pill" id="eccPill">ε = –</div>

                </div>
            </section>

            <section class="card">
                <h2>2. Pressure field and stability</h2>

                <h3>2.1 Pressure field p(θ, z)</h3>
                <canvas id="pressureCanvas" width="900" height="450"></canvas>

                <!-- <h3>2.2 Stability map</h3>
                <div class="two-cols">
                    <div>
                        <label for="rotorModel">Rotor model</label>
                        <select id="rotorModel">
                            <option value="none">None</option>
                            <option value="ross">Ross 4-DOF shaft</option>
                            <option value="friswell681">Friswell example 6.8.1</option>
                        </select>
                    </div>
                    <div>
                        <canvas id="stabilityCanvas" width="360" height="160"></canvas>
                    </div>
                </div> -->

                <!-- <div class="tag-list">
                    <span class="tag">Reynolds</span>
                    <span class="tag">K, C matrices</span>
                    <span class="tag">Rotor–bearing</span>
                </div> -->
            </section>
        </section>

        <section class="card" style="margin-top: 1rem;">
            <h2>3. Bearing stiffness and damping matrices</h2>

            <div class="two-cols">
                <div>
                    <p class="matrix-label">K matrix [N/m]</p>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>u</th>
                                <th>v</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>u</th>
                                <td id="k11">–</td>
                                <td id="k12">–</td>
                            </tr>
                            <tr>
                                <th>v</th>
                                <td id="k21">–</td>
                                <td id="k22">–</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <p class="matrix-label">C matrix [N·s/m]</p>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>u</th>
                                <th>v</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>u</th>
                                <td id="c11">–</td>
                                <td id="c12">–</td>
                            </tr>
                            <tr>
                                <th>v</th>
                                <td id="c21">–</td>
                                <td id="c22">–</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <footer>
        Task 5 – Fluid / Air Bearing Designer
    </footer>

    <script>
        function fmt(x) {
            if (!isFinite(x)) return "–";
            if (Math.abs(x) < 1e-3 || Math.abs(x) > 1e4) return x.toExponential(2);
            return x.toFixed(3);
        }

        // function updateRegimePill(eps, fluidType) {
        //     const regimePill = document.getElementById("regimePill");
        //     let regime = "light";
        //     if (eps > 0.3) regime = "medium";
        //     if (eps > 0.7) regime = "high";
        //     if (fluidType === "air") {
        //         regime += " (air)";
        //     } else {
        //         regime += " (oil)";
        //     }
        //     regimePill.textContent = "Regime: " + regime;
        // }

        function drawPressureFieldFromData(canvas, theta, z, p) {
            const ctx = canvas.getContext("2d");
            const W = canvas.width;
            const H = canvas.height;

            // ---------- Convert theta to degrees and shift ----------
            const thetaDeg = theta.map(t => {
                let d = t * 180 / Math.PI;
                if (d > 180) d -= 360;
                return d;
            });

            // ---------- Sort theta and pressure ----------
            const indices = thetaDeg.map((_, i) => i).sort((i, j) => thetaDeg[i] - thetaDeg[j]);
            const thetaSorted = indices.map(i => thetaDeg[i]);
            const pSorted = indices.map(i => p[i]);

            const Ntheta = thetaSorted.length;
            const Nz = z.length;

            // ---------- Min / Max pressure ----------
            let pMin = Infinity;
            let pMax = -Infinity;
            for (let i = 0; i < Ntheta; i++) {
                for (let j = 0; j < Nz; j++) {
                    const val = pSorted[i][j];
                    if (val < pMin) pMin = val;
                    if (val > pMax) pMax = val;
                }
            }
            if (!isFinite(pMin) || !isFinite(pMax) || pMax === pMin) {
                ctx.clearRect(0, 0, W, H);
                return;
            }

            // ---------- Layout: plot area + colorbar ----------
            const leftMargin = 70;
            const rightMargin = 120;    // Wider to fit color bar + labels
            const topMargin = 40;
            const bottomMargin = 40;

            const plotW = W - leftMargin - rightMargin;
            const plotH = H - topMargin - bottomMargin;

            const colorBarWidth = 18;
            const colorBarX = leftMargin + plotW + 15;
            const colorBarY = topMargin;

            // ---------- Background ----------
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = "#111827";     // dark background so zeros stand out
            ctx.fillRect(0, 0, W, H);

            // ---------- Heatmap with bilinear interpolation ----------
            const img = ctx.createImageData(plotW, plotH);

            // color mapping: diverging, with p ≈ 0 in a bright mid color
            function colormap(t) {
                // clamp 0..1
                t = Math.max(0, Math.min(1, t));
                // map t to [-1,1] around 0
                const x = 2 * t - 1;

                // simple diverging: blue (neg) → light/white (0) → red (pos)
                let r, g, b;
                if (x < 0) {
                    // negative: mix blue with white
                    const a = -x;            // 0..1
                    r = 255 * (1 - a);       // more white as x→0
                    g = 255 * (1 - a);
                    b = 255;
                } else {
                    // positive: mix red with white
                    const a = x;             // 0..1
                    r = 255;
                    g = 255 * (1 - a);
                    b = 255 * (1 - a);
                }
                return [Math.round(r), Math.round(g), Math.round(b)];
            }

            for (let py = 0; py < plotH; py++) {
                // map y to z-index (0..Nz-1)
                const jFloat = (py / (plotH - 1)) * (Nz - 1);
                const j0 = Math.floor(jFloat);
                const j1 = Math.min(j0 + 1, Nz - 1);
                const ty = jFloat - j0;

                for (let px = 0; px < plotW; px++) {
                    // map x to theta-index (0..Ntheta-1)
                    const iFloat = (px / (plotW - 1)) * (Ntheta - 1);
                    const i0 = Math.floor(iFloat);
                    const i1 = Math.min(i0 + 1, Ntheta - 1);
                    const tx = iFloat - i0;

                    const p00 = pSorted[i0][j0];
                    const p10 = pSorted[i1][j0];
                    const p01 = pSorted[i0][j1];
                    const p11 = pSorted[i1][j1];

                    const pTop = p00 * (1 - tx) + p10 * tx;
                    const pBot = p01 * (1 - tx) + p11 * tx;
                    const val = pTop * (1 - ty) + pBot * ty;

                    // normalised 0..1
                    const t = (val - pMin) / (pMax - pMin);
                    const [r, g, b] = colormap(t);

                    const idx = 4 * (py * plotW + px);
                    img.data[idx] = r;
                    img.data[idx + 1] = g;
                    img.data[idx + 2] = b;
                    img.data[idx + 3] = 255;
                }
            }

            // draw heatmap into plot area
            ctx.putImageData(img, leftMargin, topMargin);

            // ---------- Axes ----------
            ctx.strokeStyle = "#e5e7eb";
            ctx.lineWidth = 1.0;

            // x-axis
            ctx.beginPath();
            ctx.moveTo(leftMargin, H - bottomMargin);
            ctx.lineTo(leftMargin + plotW, H - bottomMargin);
            ctx.stroke();

            // y-axis
            ctx.beginPath();
            ctx.moveTo(leftMargin, topMargin);
            ctx.lineTo(leftMargin, H - bottomMargin);
            ctx.stroke();

            ctx.fillStyle = "#f9fafb";  // light text on dark background
            ctx.font = "12px system-ui";

            // θ ticks: -180, -90, 0, 90, 180
            const ticksX = [-180, -90, 0, 90, 180];
            ticksX.forEach(val => {
                const tx = (val + 180) / 360;              // map −180..180 → 0..1
                const x = leftMargin + tx * plotW;
                const y = H - bottomMargin;

                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x, y + 5);
                ctx.stroke();

                ctx.textAlign = "center";
                ctx.textBaseline = "top";
                ctx.fillText(val.toString(), x, y + 7);
            });

            // z ticks: zMin, maybe 0, zMax
            const zMin = z[0];
            const zMax = z[z.length - 1];
            const ticksZ = [zMin];
            if (zMin < 0 && zMax > 0) ticksZ.push(0);
            ticksZ.push(zMax);

            ticksZ.forEach(val => {
                const ty = (val - zMin) / (zMax - zMin);   // 0..1
                const y = (H - bottomMargin) - ty * plotH;
                const x = leftMargin;

                ctx.beginPath();
                ctx.moveTo(x - 5, y);
                ctx.lineTo(x, y);
                ctx.stroke();

                ctx.textAlign = "right";
                ctx.textBaseline = "middle";
                ctx.fillText(val.toFixed(3), x - 8, y);
            });

            // Axis labels
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.fillText("θ [deg]", leftMargin + plotW / 2, H - 4);

            ctx.save();
            ctx.translate(4, canvas.height / 2 - 10);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            ctx.fillText("z [m]", 0, 0);
            ctx.restore();

            // ---------- Color bar (pressure level) ----------
            // Draw color bar frame
            ctx.strokeStyle = "#e5e7eb";
            ctx.strokeRect(colorBarX, colorBarY, colorBarWidth, plotH);

            const cbImg = ctx.createImageData(colorBarWidth, plotH);
            for (let py = 0; py < plotH; py++) {
                // top = pMax, bottom = pMin
                const t = 1 - py / (plotH - 1);
                const [r, g, b] = colormap(t);
                for (let px = 0; px < colorBarWidth; px++) {
                    const idx = 4 * (py * colorBarWidth + px);
                    cbImg.data[idx] = r;
                    cbImg.data[idx + 1] = g;
                    cbImg.data[idx + 2] = b;
                    cbImg.data[idx + 3] = 255;
                }
            }
            ctx.putImageData(cbImg, colorBarX, colorBarY);

            // Pressure labels at top, middle, bottom
            ctx.fillStyle = "#f9fafb";
            ctx.font = "11px system-ui";
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";

            const midP = 0.5 * (pMin + pMax);

            ctx.fillText(pMax.toExponential(2) + " Pa", colorBarX + colorBarWidth + 4, colorBarY + 5);
            ctx.fillText(midP.toExponential(2) + " Pa", colorBarX + colorBarWidth + 4, colorBarY + plotH / 2);
            ctx.fillText(pMin.toExponential(2) + " Pa", colorBarX + colorBarWidth + 4, colorBarY + plotH - 5);

            // Color bar title
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            ctx.fillText("p [Pa]", colorBarX + colorBarWidth / 2, colorBarY - 2);
        }



        document.getElementById("friswellBtn").addEventListener("click", () => {
            // Friswell example values
            const diameter = 0.1;      // m
            const length = 0.03;     // m
            const load = 525;      // N
            const clearance = 0.1e-3;   // m
            const viscosity = 0.1;      // Pa·s
            const speed_rpm = 1500;     // rpm

            // Your UI uses radius, not diameter
            const radius = diameter / 2;

            // Populate inputs
            document.getElementById("radius").value = radius;
            document.getElementById("length").value = length;
            document.getElementById("clearance").value = clearance;
            document.getElementById("load").value = load;
            document.getElementById("viscosity").value = viscosity;
            document.getElementById("speedRpm").value = speed_rpm;

            // Optional status update
            document.getElementById("statusText").textContent = "Status: Friswell example loaded";
        });

        document.getElementById("runBtn").addEventListener("click", async () => {
            const bearingType = document.getElementById("bearingType").value;
            const fluidType = document.getElementById("fluidType").value;
            const R = Number(document.getElementById("radius").value);
            const L = Number(document.getElementById("length").value);
            const c = Number(document.getElementById("clearance").value);
            const n_rpm = Number(document.getElementById("speedRpm").value);
            const W = Number(document.getElementById("load").value);
            const mu = Number(document.getElementById("viscosity").value);


            const status = document.getElementById("statusText");
            status.textContent = "Status: running…";

            try {
                const diameter = 2 * R;
                const payload = {
                    bearingType,
                    fluidType,
                    diameter,
                    length: L,
                    clearance: c,
                    load: W,
                    viscosity: mu,
                    speed_rpm: n_rpm,

                };

                const response = await fetch("http://127.0.0.1:5000/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error("Backend error: " + response.status);
                }

                const data = await response.json();

                const eps = data.eps;

                const K = data.K;
                const C = data.C;
                const theta = data.theta;
                const z = data.z;
                const p = data.p;

                document.getElementById("eccPill").textContent = "ε = " + fmt(eps);

                // updateRegimePill(eps, fluidType);

                document.getElementById("k11").textContent = fmt(K[0][0]);
                document.getElementById("k12").textContent = fmt(K[0][1]);
                document.getElementById("k21").textContent = fmt(K[1][0]);
                document.getElementById("k22").textContent = fmt(K[1][1]);

                document.getElementById("c11").textContent = fmt(C[0][0]);
                document.getElementById("c12").textContent = fmt(C[0][1]);
                document.getElementById("c21").textContent = fmt(C[1][0]);
                document.getElementById("c22").textContent = fmt(C[1][1]);

                const pressureCanvas = document.getElementById("pressureCanvas");
                drawPressureFieldFromData(pressureCanvas, theta, z, p);

                //const rotorModel = document.getElementById("rotorModel").value;
                // const stabilityCanvas = document.getElementById("stabilityCanvas");
                // drawStabilityMap(stabilityCanvas, rotorModel, eps);

                status.textContent = "Status: analysis complete";
            } catch (err) {
                console.error(err);
                status.textContent = "Status: error";
            }
        });

        // document.getElementById("rotorModel").addEventListener("change", () => {
        //     const rotorModel = document.getElementById("rotorModel").value;
        //     const eccText = document.getElementById("eccPill").textContent;
        //     const eps = parseFloat(eccText.split("=").pop()) || 0.3;
        //     const stabilityCanvas = document.getElementById("stabilityCanvas");
        //     drawStabilityMap(stabilityCanvas, rotorModel, eps);
        // });

        document.getElementById("exportBtn").addEventListener("click", () => {
            window.print();
        });

        drawPressureFieldFromData(
            document.getElementById("pressureCanvas"),
            [0, 1],
            [0, 1],
            [[0, 0], [0, 0]]
        );
        // drawStabilityMap(document.getElementById("stabilityCanvas"), "none", 0.3);

    </script>

</body>

</html>